import{g as e}from"./highlight.BhMHDnLY.js";import{d as a,A as l,r as u,G as t,x as s,B as r,E as o,v as n,c as i,w as c,i as v,I as d,ag as m,K as h,M as p,as as f,o as y,a as E,b as _,R as g,u as k,h as C,g as D,k as O,F as R,e as A,y as I,P as T,t as L,n as N,a5 as b,D as S,a0 as H,_ as W}from"./index-CK4DGatK.js";import{_ as j}from"./ljt.oTiZI4wC.js";import{N as V}from"./NavBar.DSs5OGCU.js";import{c as M}from"./carListItem.hYH6YShY.js";import{u as P}from"./useQuery.3dd8K18V.js";import{d as U}from"./debounce.BkVTat1y.js";import{o as x}from"./omit.DzeQdT5l.js";import{i as w}from"./isNil.aV-w2MPu.js";import"./time._VqwKl0d.js";import"./image.DobRSNlT.js";import"./isObject.C8HfsiHw.js";import"./isSymbol.Bym6OQCA.js";import"./_baseGet.CmhOSbYr.js";import"./_getTag.DG-N9UUn.js";import"./_Uint8Array.B4mhORiM.js";import"./_baseClone.Cc-Y92km.js";const z=W(a({__name:"searchCar",setup(a){const W=P(),z=l(),K=u([{name:"综合",num:null,value:"TOTAL",dataKey:""},{name:"精品车",num:0,value:"VEHICLE",dataKey:"carPremiumList"},{name:"特价车",num:0,value:"DISCOUNT",dataKey:"carDiscountList"}]);{const e=["/pages/sells/index"],a=t("userMenuPermission")?JSON.parse(t("userMenuPermission")):[],l=a.length>0?a.map((e=>e.path)):[];if(e&&e instanceof Array&&e.length>0){l.some((a=>e.includes(a)))&&K.value.push({name:"订单",num:0,value:"ORDER",dataKey:"orderCarList"})}}const $=s((()=>K.value.reduce(((e,a)=>e+(a.num??0)),0))),F=(e,a)=>{const l=K.value.find((e=>e.value==a));l&&(l.num=Number(e??0))},G=e=>K.value.find((a=>a.value==e))||{},Q=u(0),B=s((()=>K.value[Q.value])),J=u(0),Y=u("loadmore"),Z=u({keyWord:"",current:1,size:5,total:0,status:"VEHICLE"}),q=u([]),X=u([]),ee=u(null),ae=u(),le=z.loginInfo.user_id;r((e=>{ae.value=e,ve()}));const ue=u([]),te=u(!0),se=u(!0);o((()=>{ue.value=JSON.parse(t("userBtnPermission")||"[]").map((e=>e)),ue.value.includes("product:info")||ue.value.includes("inventory:info")?te.value=!0:te.value=!1,ue.value.includes("sells:info")?se.value=!0:se.value=!1,fe.value&&!le&&z.loginInfo.user_id&&(Z.value.current=1,he())}));const re=u([]),oe=u(!1),ne=u(!1),ie=u(!1);async function ce(){if(!ie.value){if(oe.value=!!Z.value.keyWord,!Z.value.keyWord)return ne.value=!1,void(re.value=[]);ne.value=!0,re.value=[];try{const e=((await uni.$u.http.get("/product/carSeries/getSeries",{params:{name:Z.value.keyWord,containsAll:!1}})).data||[]).flatMap((e=>(e.carSeries||[]).map((a=>({...a,brandId:e.brandId})))));re.value=e,oe.value=!!e.length}finally{ne.value=!1}}}n((()=>Z.value.keyWord),U(ce,100));const ve=()=>{uni.$u.http.get("/product/carProductApp/getSearchHistory").then((e=>{q.value=e.data}))},de=u(),me=e=>{const a=K.value.findIndex((a=>a.value==e));Q.value=a,X.value=[],Z.value.current=1,he()},he=()=>{Y.value="loading";const e={TOTAL:()=>({keyWord:fe.value}),VEHICLE:()=>({...x(Z.value,"total","keyWord"),choicenessFlag:1,status:"VEHICLE",keyWord:fe.value}),DISCOUNT:()=>({...x(Z.value,"total","keyWord"),status:"VEHICLE",choicenessFlag:0,keyWord:fe.value}),ORDER:()=>({...x(Z.value,"total","keyWord"),status:"ORDER",keyWord:fe.value})}[B.value.value]();"TOTAL"===B.value.value&&uni.$u.http.get("/product/carProductApp/synthesis",{params:{...e,sourceModel:"car"==ae.value.source?"CAR_MANAGEMENT":"sale"==ae.value.source?"SALE_ORDE":""}}).then((e=>{ee.value=e.data,F(e.data.carPremiumNum,"VEHICLE"),F(e.data.carDiscountNum,"DISCOUNT"),F(e.data.orderCarNum,"ORDER"),te.value||(F(0,"VEHICLE"),F(0,"DISCOUNT")),se.value||F(0,"ORDER"),W.value.testDrive&&(K.value=K.value.filter((e=>"ORDER"!==e.value)))})),["VEHICLE","DISCOUNT"].includes(B.value.value)&&(te.value?uni.$u.http.post("/product/carProductApp/vehiclePage",{...e,sourceModel:"car"==ae.value.source?"CAR_MANAGEMENT":"sale"==ae.value.source?"SALE_ORDE":""}).then((e=>{1===Z.value.current?X.value=e.data.results||[]:X.value=X.value.concat(e.data.results),Z.value.total=e.data.count||0,0===Z.value.total&&(Y.value="nomore"),X.value.length>=Z.value.total&&(Y.value="nomore"),de.value.scrollTop=0})).catch((()=>{Y.value="nomore"})):(X.value=[],Y.value="nomore")),"ORDER"===B.value.value&&(se.value?uni.$u.http.post("/product/carProductApp/vehiclePage",{...e,sourceModel:"car"==ae.value.source?"CAR_MANAGEMENT":"sale"==ae.value.source?"SALE_ORDE":""}).then((e=>{1===Z.value.current?X.value=e.data.results||[]:X.value=X.value.concat(e.data.results),Z.value.total=e.data.count||0,0===Z.value.total&&(Y.value="nomore"),X.value.length>=Z.value.total&&(Y.value="nomore"),de.value.scrollTop=0})).catch((()=>{Y.value="nomore"})):(X.value=[],Y.value="nomore")),setTimeout((()=>{ie.value=!1}),200)},pe=()=>{Y.value="loading",X.value.length>=Z.value.total?Y.value="nomore":(Z.value.current++,he())},fe=u(""),ye=()=>{""!=Z.value.keyWord.trim()?(ie.value=!0,oe.value=!1,Z.value.current=1,Q.value=0,fe.value=Z.value.keyWord,he(),ve()):(new S).showToast("请输入搜索内容")},Ee=()=>{uni.$u.http.delete("/product/carProductApp/delSearchHistory").then((e=>{0==e.code&&(H({title:"清除成功",icon:"none"}),ve())}))},_e=()=>{Z.value.keyWord="",ee.value=null,X.value=[],re.value=[],oe.value=!1,F(0,"TOTAL"),F(0,"VEHICLE"),F(0,"ORDER"),Q.value=0};return(a,l)=>{const u=g,t=C,s=v,r=d(h("up-loading-icon"),m),o=T,n=d(h("up-icon"),p),S=d(h("u-loadmore"),f),H=b;return y(),i(s,{class:"page f-c-s"},{default:c((()=>[E(V,{isSearch:!0,title:"搜索"},{title:c((()=>[E(s,{class:"search-input f-r-s"},{default:c((()=>[E(u,{onFocus:ce,modelValue:k(Z).keyWord,"onUpdate:modelValue":l[0]||(l[0]=e=>k(Z).keyWord=e),focus:!0,placeholder:"车型/VIN码/订单"},null,8,["modelValue"]),E(s,{class:"search-btn",onClick:ye},{default:c((()=>[E(t,null,{default:c((()=>[D("搜 索")])),_:1})])),_:1})])),_:1})])),_:1}),k(oe)?(y(),_("div",{key:0,class:"suggestion-box"},[k(ne)?(y(),i(r,{key:0})):k(re).length?(y(),_("div",{key:1,class:"pop-content"},[O("div",{class:"list-box"},[(y(!0),_(R,null,A(k(re),(l=>(y(),_("div",{class:"item",onClick:e=>function(e){Z.value.keyWord=e.name,oe.value=!1,re.value=[],ie.value=!0,ye()}(l),key:l.id,innerHTML:("getHighlightText"in a?a.getHighlightText:k(e))(l.name,k(Z).keyWord)},null,8,["onClick","innerHTML"])))),128))])])):(y(),_("div",{key:2,class:"search-empty"},"暂无数据"))])):(y(),_(R,{key:1},[!k(ee)&&0==G("VEHICLE").num&&0==G("DISCOUNT").num&&0==G("ORDER").num&&k(q).length?(y(),_(R,{key:0},[E(s,{class:"history"},{default:c((()=>[E(s,{class:"title"},{default:c((()=>[D("搜索记录")])),_:1}),E(o,{class:"img",src:j,onClick:Ee})])),_:1}),E(s,{class:"h-content"},{default:c((()=>[(y(!0),_(R,null,A(k(q),((e,a)=>(y(),i(s,{class:"tag",key:a,onClick:a=>{return l=e.name,fe.value=l,Z.value.keyWord=l,ie.value=!0,void he();var l}},{default:c((()=>[D(L(e.name),1)])),_:2},1032,["onClick"])))),128))])),_:1})],64)):I("",!0),k($)>0?(y(),i(s,{key:1,class:"inners"},{default:c((()=>[E(s,{class:"tab-box"},{default:c((()=>[E(s,{class:"tabs"},{default:c((()=>[(y(!0),_(R,null,A(k(K),((e,a)=>(y(),i(s,{key:a,class:N({active:k(Q)==a}),onClick:e=>(e=>{e!=Q.value&&(Q.value=e,X.value=[],Z.value.current=1,he())})(a)},{default:c((()=>[D(L(e.name),1),k(w)(e.num)?I("",!0):(y(),_("span",{key:0},"("+L(e.num)+")",1))])),_:2},1032,["class","onClick"])))),128))])),_:1}),!k(ee)&&0==G("VEHICLE").num&&0==G("DISCOUNT").num&&0==G("ORDER").num&&k(q).length?(y(),i(o,{key:0,src:j,onClick:_e})):I("",!0)])),_:1}),"TOTAL"===k(B).value?(y(),i(s,{key:0,class:"zonghe"},{default:c((()=>[(k(ue).includes("product:info")||k(ue).includes("inventory:info"))&&G("VEHICLE").num>0?(y(),i(s,{key:0,class:"zong-item"},{default:c((()=>[E(s,{class:"sub-title"},{default:c((()=>[E(t,null,{default:c((()=>[D("精品车("+L(G("VEHICLE").num)+")",1)])),_:1}),E(s,{onClick:l[1]||(l[1]=e=>me("VEHICLE")),class:"btn"},{default:c((()=>[D("查看全部"),E(n,{name:"arrow-right",color:"#999",size:"12"})])),_:1})])),_:1}),E(s,{class:"sub-inner"},{default:c((()=>{var e,a;return[E(M,{hasCarAuth:k(te),occasion:"search",testDrive:k(W).testDrive,item:null==(a=null==(e=k(ee))?void 0:e[G("VEHICLE").dataKey])?void 0:a[0]},null,8,["hasCarAuth","testDrive","item"])]})),_:1})])),_:1})):I("",!0),(k(ue).includes("product:info")||k(ue).includes("inventory:info"))&&G("DISCOUNT").num>0?(y(),i(s,{key:1,class:"zong-item"},{default:c((()=>[E(s,{class:"sub-title"},{default:c((()=>[E(t,null,{default:c((()=>[D("特价车("+L(G("DISCOUNT").num)+")",1)])),_:1}),E(s,{onClick:l[2]||(l[2]=e=>me("DISCOUNT")),class:"btn"},{default:c((()=>[D("查看全部"),E(n,{name:"arrow-right",color:"#999",size:"12"})])),_:1})])),_:1}),E(s,{class:"sub-inner"},{default:c((()=>{var e,a;return[E(M,{hasCarAuth:k(te),occasion:"search",testDrive:k(W).testDrive,item:null==(a=null==(e=k(ee))?void 0:e[G("DISCOUNT").dataKey])?void 0:a[0]},null,8,["hasCarAuth","testDrive","item"])]})),_:1})])),_:1})):I("",!0),k(ue).includes("sells:info")&&G("ORDER").num>0&&!k(W).testDrive?(y(),i(s,{key:2,class:"zong-item"},{default:c((()=>[E(s,{class:"sub-title"},{default:c((()=>[E(t,null,{default:c((()=>[D("订单("+L(G("ORDER").num)+")",1)])),_:1}),E(s,{onClick:l[3]||(l[3]=e=>me("ORDER")),class:"btn"},{default:c((()=>[D("查看全部"),E(n,{name:"arrow-right",color:"#999",size:"12"})])),_:1})])),_:1}),E(s,{class:"sub-inner"},{default:c((()=>{var e,a;return[E(M,{hasOrderAuth:k(se),isOrders:!0,item:null==(a=null==(e=k(ee))?void 0:e[G("ORDER").dataKey])?void 0:a[0]},null,8,["hasOrderAuth","item"])]})),_:1})])),_:1})):I("",!0)])),_:1})):(y(),i(H,{key:1,ref_key:"scrollRefs",ref:de,class:"scroll-view","scroll-top":k(J),"scroll-y":"",onScrolltolower:pe},{default:c((()=>[(y(!0),_(R,null,A(k(X),((e,a)=>(y(),i(M,{hasCarAuth:k(te),hasOrderAuth:k(se),occasion:"ORDER"!==k(B).value?"search":"public",isOrders:"ORDER"===k(B).value,key:a,item:e,routerQuery:k(ae)},null,8,["hasCarAuth","hasOrderAuth","occasion","isOrders","item","routerQuery"])))),128)),E(s,{class:"load-more"},{default:c((()=>[E(S,{status:k(Y),testDrive:k(W).testDrive,nomoreText:k(X).length?"没有更多了":"暂无数据"},null,8,["status","testDrive","nomoreText"])])),_:1})])),_:1},8,["scroll-top"]))])),_:1})):I("",!0),k(ee)&&!k($)?(y(),i(s,{key:2,class:"no-content"},{default:c((()=>[E(o,{src:"https://sjmc.obs.cn-north-4.myhuaweicloud.com/static/service/no_car_s.png",class:"pic",mode:"aspectFit"}),E(s,null,{default:c((()=>[D("无相关内容")])),_:1})])),_:1})):I("",!0)],64))])),_:1})}}}),[["__scopeId","data-v-2440d8a8"]]);export{z as default};
