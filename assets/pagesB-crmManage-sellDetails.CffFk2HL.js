import{d as e,x as a,r as l,I as t,aP as s,K as u,aQ as o,ac as n,c as r,o as i,w as d,a as c,i as v,u as m,b as p,e as f,F as _,a5 as h,g as y,t as I,$ as g,_ as C,B as w,E as T,X as j,Y as b,D as $,a1 as k,Z as S,a2 as D,s as B,ak as M,M as N,aq as O,y as A,h as x,n as L,Q as P,aU as R,a0 as U,c1 as q}from"./index-CK4DGatK.js";import{R as E}from"./remarkPop.C_hUies3.js";import{c as J}from"./crm.-ZWUD7KR.js";import{N as F,B as K,a as Q,b as V}from"./NavBar.B8fX5M2s.js";import{u as Z}from"./useQuery.3dd8K18V.js";import"./close.Dhgi5Ijg.js";import"./callPhone.KEQUzljZ.js";import"./useDict.DwAUsZFY.js";import"./index.HDA2F_3Q.js";import"./ListLoadRefreshView.CnNC2lkG.js";import"./carListItem.hYH6YShY.js";import"./time._VqwKl0d.js";import"./image.DobRSNlT.js";import"./omit.DzeQdT5l.js";import"./_baseGet.CmhOSbYr.js";import"./_getTag.DG-N9UUn.js";import"./isObject.C8HfsiHw.js";import"./isSymbol.Bym6OQCA.js";import"./_Uint8Array.B4mhORiM.js";import"./_baseClone.Cc-Y92km.js";import"./isNil.aV-w2MPu.js";import"./listItem.De6Dqo0z.js";import"./car_default.CyENNAub.js";import"./purchase.B8DNaFGL.js";import"./fixPrice.CFXyKkhm.js";import"./base.6l0JEBJr.js";const z=C(e({__name:"detailPop",props:{show:{type:Boolean},detail:{default:{}}},emits:["close"],setup(e,{emit:C}){const w=e,T=C,j=["待联系","评估中","成交"],b=["待联系","已战败"],$=["待联系","已无效"],k=a((()=>{var e,a;return 4===(null==(e=w.detail)?void 0:e.orderStatus)?b:5===(null==(a=w.detail)?void 0:a.orderStatus)?$:j})),S=a((()=>{var e,a,l;return null===(null==(e=w.detail)?void 0:e.orderStatus)?0:[4,5,7].includes(null==(a=w.detail)?void 0:a.orderStatus)?1:null==(l=w.detail)?void 0:l.orderStatus})),D=()=>{!async function(){var e,a;const l={clueId:null==(e=w.detail)?void 0:e.clueId},t=await g().get(J.getClueByPurchase,{params:l});M.value=null==(a=null==t?void 0:t.data)?void 0:a[0]}()},B=()=>{T("close")},M=l();return(e,a)=>{const l=t(u("up-steps-item"),s),g=t(u("up-steps"),o),C=v,T=h,j=t(u("u-popup"),n);return i(),r(j,{mode:"bottom",round:20,closeable:"",closeOnClickOverlay:!0,show:w.show,onOpen:D,onClose:B},{default:d((()=>[c(C,{class:"detail-pop"},{default:d((()=>[c(C,{class:"pop-box"},{default:d((()=>[c(C,{class:"detail-item"},{default:d((()=>[c(g,{current:m(S),dot:"",activeColor:"#ff5719"},{default:d((()=>[(i(!0),p(_,null,f(m(k),(e=>(i(),r(l,{title:e,key:e},null,8,["title"])))),128))])),_:1},8,["current"])])),_:1}),c(T,{class:"scrolls","scroll-y":""},{default:d((()=>[c(C,{class:"info-item"},{default:d((()=>[c(C,{class:"label"},{default:d((()=>[y("评估车型:")])),_:1}),c(C,{class:"val"},{default:d((()=>{var e;return[y(I((null==(e=m(M))?void 0:e.modelName)||"--"),1)]})),_:1})])),_:1}),c(C,{class:"info-item"},{default:d((()=>[c(C,{class:"label"},{default:d((()=>[y("VIN码:")])),_:1}),c(C,{class:"val"},{default:d((()=>{var e;return[y(I((null==(e=m(M))?void 0:e.vin)||"--"),1)]})),_:1})])),_:1}),c(C,{class:"info-item"},{default:d((()=>[c(C,{class:"label"},{default:d((()=>[y("公里数:")])),_:1}),c(C,{class:"val"},{default:d((()=>{var e;return[y(I((null==(e=m(M))?void 0:e.kilometres)?m(M).kilometres+"万公里":"--"),1)]})),_:1})])),_:1}),c(C,{class:"info-item"},{default:d((()=>[c(C,{class:"label"},{default:d((()=>[y("车身颜色:")])),_:1}),c(C,{class:"val"},{default:d((()=>{var e;return[y(I((null==(e=m(M))?void 0:e.colorSource)||"--"),1)]})),_:1})])),_:1}),c(C,{class:"info-item"},{default:d((()=>[c(C,{class:"label"},{default:d((()=>[y("出厂日期:")])),_:1}),c(C,{class:"val"},{default:d((()=>{var e;return[y(I((null==(e=m(M))?void 0:e.factoryDate)||"--"),1)]})),_:1})])),_:1}),c(C,{class:"info-item"},{default:d((()=>[c(C,{class:"label"},{default:d((()=>[y("上牌日期:")])),_:1}),c(C,{class:"val"},{default:d((()=>{var e;return[y(I((null==(e=m(M))?void 0:e.registrationTime)||"--"),1)]})),_:1})])),_:1}),c(C,{class:"info-item"},{default:d((()=>[c(C,{class:"label"},{default:d((()=>[y("客户预估价格:")])),_:1}),c(C,{class:"val"},{default:d((()=>{var e,a;return[y(I((null==(e=m(M))?void 0:e.priceMin)||"--")+"万 - "+I((null==(a=m(M))?void 0:a.priceMax)||"--")+"万",1)]})),_:1})])),_:1}),c(C,{class:"info-item"},{default:d((()=>[c(C,{class:"label"},{default:d((()=>[y("描述:")])),_:1}),c(C,{class:"val"},{default:d((()=>{var e;return[y(I((null==(e=m(M))?void 0:e.description)||"--"),1)]})),_:1})])),_:1})])),_:1})])),_:1})])),_:1})])),_:1},8,["show"])}}}),[["__scopeId","data-v-c6177c62"]]),G=C(e({__name:"sellDetails",setup(e){const a=Z(),s=l(),o=l();q("crm-customerId",o);const n=["待联系","评估中","成交"],p=l(),f=l(),_=l([]),h=l(0),C=l(),G=l({}),W=l(0),X=l();w((()=>{p.value=a.value.id,f.value=a.value.clueId,me(),Y()})),T((async()=>{j("sellData"),b("sellData",(e=>{var a,l;const{id:t,queryData:u}=e,o=4==(null==(a=JSON.parse(u))?void 0:a.transfer)?"/crm/customer/transfer/approve":"/crm/customer/transfer";uni.$u.http.post(o,{type:s.value.clueType,clueIdList:[f.value],followUpId:t,transfer:4==(null==(l=JSON.parse(u))?void 0:l.transfer)}).then((()=>{(new $).showToast("提交成功"),setTimeout((()=>{k()}),1500)}))})),j("refreshDetail"),b("refreshDetail",(e=>{Y()}))}));const Y=()=>{S({title:"加载中",mask:!0});try{H(),ee()}finally{D()}};async function H(){var e,a,l;const t={clueId:f.value},u=await g().get(J.getUserByClueId,{params:t});s.value=null==u?void 0:u.data,o.value=null==(e=s.value)?void 0:e.userId;const{id:n,clueType:r,intentionCode:i,orderStatus:d}=u.data;_.value=[{id:n,clueId:f.value,clueType:r,intentionCode:i,orderStatus:d}],W.value+=1;const c=(null==(a=u.data)?void 0:a.allotAuth)?"":"分配";le.value=[{name:"编辑",value:"1"},{name:"转销售",value:"2"},{name:"分配",value:"3"},{name:"移交",value:"4"},{name:"放弃",value:"5"}].filter((e=>e.name!=c)),ae(),null==(l=X.value)||l.getElementTop()}const ee=()=>{uni.$u.http.get("/crm/customer/purchase",{params:{customerId:p.value,clueId:f.value}}).then((e=>{G.value=e.data,B((()=>{var e;je(),null==(e=X.value)||e.getElementTop()}))}))},ae=()=>{uni.$u.http.get("/crm/clue/getAllMypurchase",{params:{customerId:p.value}}).then((e=>{const a=e.data.filter((e=>e.id!=_.value[0].clueId)).map((e=>({id:e.crmCustomerId,clueId:e.id,clueType:e.clueType,intentionCode:e.intentionCode,orderStatus:e.orderStatus})));_.value=[..._.value,...a]}))},le=l([]),te=e=>{"放弃"===e.name?P(`/pagesB/crmManage/components/abandon?clueType=${s.value.clueType}&clueId=${a.value.clueId}`):"分配"===e.name||"移交"===e.name?P(`/pages/carManage/sellUserList?title=${e.name}&id=${s.value.userId}&sureBtn=1&queryData=${JSON.stringify({transfer:e.value})}`):"转销售"===e.name?P(`/pagesB/crmManage/addCustom?${R({title:"新增销售机会",customerId:p.value,clueId:f.value,type:"sellAddDto",isChange:1})}`):"编辑"===e.name&&P(`/pagesB/crmManage/addCustom?${R({title:"编辑用户",customerId:p.value,clueId:f.value,type:"customerAddDto"})}`)},se=()=>{P(`/pagesB/crmManage/components/sell/addFollow?clueId=${f.value}&clueType=${s.value.clueType}&customerId=${p.value}`)},ue=l(!1),oe=l(!1),ne=l(),re=l([]),ie=l(),de=l([]),ce=l(!0),ve=l(),me=()=>{uni.$u.http.get(J.intentionInfolist,{data:{current:1,size:-1,type:"1"}}).then((e=>{var a,l;de.value=[...null==(l=null==(a=e.data)?void 0:a.results)?void 0:l.map((e=>({name:e.code,value:e.code}))),{name:"新增机会",value:"新增机会"}]}))},pe=e=>{ie.value=e,"成交"===e.value?(oe.value=!0,ne.value="成交时间"):"新增机会"===e.value?P(`/pagesB/crmManage/addCustom?${R({title:"新增评估机会",customerId:p.value,clueId:f.value,type:"purchaseAddDto",isChange:1,isAdd:1})}`):(oe.value=!0,ne.value=`${e.name}原因`)},fe=()=>{oe.value=!1},_e=e=>{const a={crmClueId:f.value,result:ie.value.value,clueType:s.value.clueType,crmCustomerId:s.value.id};"成交"===ie.value.value?a.dealTime=e:a.content=e,uni.$u.http.post(J.followLog,a).then((e=>{U({title:"操作成功",icon:"none"}),fe(),H()}))},he=l(!1),ye=l("detail"),Ie=l(),ge=()=>{P(`/pagesB/crmManage/addCustom?${R({clueId:f.value,customerId:p.value,type:"purchaseAddDto",title:"编辑评估机会"})}`)},Ce=()=>{const e={clueType:s.value.clueType,crmCustomerId:s.value.id,attention:s.value.attention?0:1},a=s.value.attention?"取消重点客户成功":"标记重点客户成功";uni.$u.http.post(J.markImportant,e).then((()=>{U({title:a,icon:"none"}),H()}))},we=()=>{P(`/pagesB/crmManage/components/setTags?id=${p.value}&clueType=${a.value.clueType}`)},Te=(e,a)=>{p.value=e.id,f.value=e.clueId,h.value=a,ee(),ce.value=!0},je=()=>{setTimeout((()=>{M().in(this).select(".hide-desc").boundingClientRect((e=>{if(e){const a=Math.ceil(e.height/22);ve.value=a>10}})).exec()}),30)},be=()=>{var e;ce.value=!ce.value,null==(e=X.value)||e.getElementTop()};return(e,a)=>{const l=v,o=x,p=t(u("up-icon"),N),h=t(u("up-action-sheet"),O);return i(),r(l,{class:"sell-details"},{default:d((()=>{var e;return[c(F,{data:m(s),onImport:Ce},null,8,["data"]),c(l,{class:"section"},{default:d((()=>[c(K,{ref_key:"baseInfoRef",ref:X,data:m(s),stepList1:n,chanceList:m(_),stepsKey:m(W),onAddTag:we,onChangeClue:Te},{detail:d((()=>[c(l,{class:"slot-detail"},{default:d((()=>[m(G).modelName?(i(),r(l,{key:0,class:"model"},{default:d((()=>[y(I(m(G).modelName),1)])),_:1})):A("",!0),c(l,{class:"info"},{default:d((()=>[c(o,null,{default:d((()=>[y(I(m(G).registrationTime||"-")+"上牌",1)])),_:1}),y("| "),c(o,null,{default:d((()=>[y(I(m(G).kilometres||"-")+"万公里",1)])),_:1}),y("| "),c(o,null,{default:d((()=>[y(I(m(G).colorSource||"-"),1)])),_:1})])),_:1}),c(l,{class:"info"},{default:d((()=>[c(o,null,{default:d((()=>[y(I(m(G).factoryDate||"-")+"出厂",1)])),_:1}),y("| "),c(o,null,{default:d((()=>[y("客户预估价格"+I(m(G).priceMin||"-")+"万",1)])),_:1})])),_:1}),c(l,{class:"des"},{default:d((()=>[c(l,null,{default:d((()=>[y("详细车况")])),_:1}),c(l,{class:L(["word-warp show-desc",{collapsed:!m(ce)}])},{default:d((()=>[y(I(m(G).description||"-"),1)])),_:1},8,["class"]),m(ve)?(i(),r(l,{key:0,class:"show-mores",onClick:be},{default:d((()=>[y(I(m(ce)?"展开":"收起")+" ",1),c(p,{name:m(ce)?"arrow-down":"arrow-up",size:"14",color:"#0079fe"},null,8,["name"])])),_:1})):A("",!0),c(l,{class:"word-warp hide-desc"},{default:d((()=>[y(I(m(G).description||"-"),1)])),_:1})])),_:1})])),_:1})])),footer:d((e=>[c(l,{class:"action-btn",onClick:ge},{default:d((()=>[y("编辑机会")])),_:1}),c(l,{class:"action-btn",onClick:a=>(e=>{var a;const l=4===e||5===e?"成交":"";re.value=null==(a=de.value)?void 0:a.filter((e=>e.value!==l)),ue.value=!0})(e.orderStatus)},{default:d((()=>[y("结束机会")])),_:2},1032,["onClick"]),c(l,{class:"action-btn",onClick:a[0]||(a[0]=e=>{return a="detail",ye.value=a,Ie.value={...s.value,clueId:f.value},void(he.value=!0);var a})},{default:d((()=>[y("详情")])),_:1})])),_:1},8,["data","chanceList","stepsKey"]),c(Q,{ref_key:"BuyInfoCardRef",ref:C},null,512)])),_:1}),c(h,{title:"结束机会",class:"pop-action",onSelect:pe,onClose:a[1]||(a[1]=e=>ue.value=!1),actions:m(re),closeOnClickOverlay:!0,closeOnClickAction:!0,cancelText:"取消",show:m(ue)},null,8,["actions","show"]),c(V,{options:m(le),phone:null==(e=m(s))?void 0:e.phone,onSheet:te,onFollow:se},null,8,["options","phone"]),c(E,{show:m(oe),title:m(ne),onClose:fe,onSubmit:_e},null,8,["show","title"]),c(z,{show:m(he),current:m(ye),onClose:a[2]||(a[2]=e=>he.value=!1),detail:m(Ie)},null,8,["show","current","detail"])]})),_:1})}}}),[["__scopeId","data-v-6c7aff75"]]);export{G as default};
