import{d as a,A as e,r as l,a9 as t,B as o,C as c,b2 as r,E as s,X as u,Y as n,D as d,a2 as p,c as i,w as m,i as f,I as _,M as y,K as h,bH as I,aq as k,o as v,a as T,u as g,g as P,h as N,Q as C,n as b,t as A,y as w,S as E,b as U,F as V,e as O,R,aj as j,W as x,au as D,s as S,$ as M,a1 as F,_ as L}from"./index-CK4DGatK.js";import{D as B}from"./listItem.CnogksUc.js";import{U as K}from"./UploadFile.BBuXxkzB.js";import{u as $}from"./useQuery.3dd8K18V.js";import{a as H}from"./index.HDA2F_3Q.js";import"./avatar.Buy0-vr1.js";import"./car_default.CyENNAub.js";import"./refuse.BEcO0WCW.js";import"./close.Dhgi5Ijg.js";import"./task.Cx6XxNwo.js";import"./isNil.aV-w2MPu.js";import"./dev.3CSglq9A.js";import"./index.BP9c-u7r.js";import"./image.DobRSNlT.js";import"./play.dJbs8fP_.js";import"./vuedraggable.umd.DwpyKIuh.js";const Y=L(a({__name:"addOrder",setup(a){const L=$(),Y=e(),W=l({}),q=t({prepareUserId:"",prepareUserName:"",factoryName:"",factoryInfoId:"",factoryType:"",paymentMethods:"CORPORATE_PAYMENT",accountTypeId:"",accountType:null,accountTypeName:"",accountName:"",account:"",bank:"",prepareStartTime:"",prepareEndTime:"",attachments:[],description:""}),Q=l([{key:"CORPORATE_PAYMENT",value:"公司付款"},{key:"EMPLOYEE_ADVANCE",value:"员工垫付"}]),J=l([{name:"银行卡",key:"BANK_CARD"},{name:"微信",key:"ALIPAY"},{name:"支付宝",key:"WECHAT"}]),X=l(),z=l(!1),G=l(!1),Z=l([{prepareInfoId:"",prepareName:"",amount:"",description:""}]),aa=l(0);o((()=>{c({scrollTop:0,duration:0}),r({title:L.value.id?"编辑整备工单":"新增整备工单"}),L.value.carProductId&&ea(),L.value.id&&la(),q.prepareUserId=Y.userInfo.userId,q.prepareUserName=Y.userInfo.name})),s((()=>{const a={BANK_CARD:"银行卡",ALIPAY:"支付宝",WECHAT:"微信"};u("sellData"),n("sellData",(a=>{const{name:e,id:l}=a;q.prepareUserName=e,q.prepareUserId=l})),u("pickData"),n("pickData",(a=>{const{name:e,id:l,index:t}=a;t?(Z.value[t].prepareInfoId=l,Z.value[t].prepareName=e):(q.factoryName=e,q.factoryInfoId=l,q.factoryType="REPAIR_SHOP")})),u("checkAccount"),n("checkAccount",(e=>{const{id:l,account:t,bank:o,infoType:c,name:r}=e;q.accountTypeId=l,q.accountType=c,q.accountTypeName=a[c],q.accountName=r,q.account=t,q.bank=o})),u("addOrderSet"),n("addOrderSet",(a=>{const{id:e,name:l,pageKey:t}=a;"REPAIR_SHOP"==t&&e==q.factoryInfoId&&(q.factoryName=l),"SERVICE_ITEM"==t&&Z.value.forEach((a=>{a.prepareInfoId==e&&(a.prepareName=l)}))})),u("addOrderAccount"),n("addOrderAccount",(e=>{const{account:l,bank:t,infoType:o,name:c}=e;e.prepareInfoId==q.accountTypeId&&(q.accountType=o,q.accountTypeName=a[o],q.accountName=c,q.account=l,q.bank=t)}))}));const ea=()=>{(new d).showLoading("加载中"),uni.$u.http.get("/product/carProductPrepare/workOrder",{params:{carProductId:L.value.carProductId}}).then((a=>{W.value=a.data;const{coverUrl:e}=a.data.carProductBasic;W.value.carProductBasic={...a.data.carProductBasic,photoUrl:e},p()}))},la=()=>{(new d).showLoading("加载中"),uni.$u.http.get("/product/carProductPrepare/workOrderDetails",{params:{prepareId:L.value.id}}).then((a=>{const{carProductPrepares:e,attachments:l,prepareRelations:t}=a.data,o={...q,...Object.keys(q).reduce(((a,l)=>l in e[0]?{...a,[l]:e[0][l]}:a),{}),attachments:null==l?void 0:l.map((a=>({id:a.attachmentId,attachmentId:a.attachmentId,attachmentUrl:a.attachmentUrl}))),factoryType:"REPAIR_SHOP"};Object.assign(q,o),Z.value=t,aa.value=e[0].amount,console.log(q),p()}))},ta=()=>{q.factoryName="",q.factoryInfoId="",q.factoryType=""},oa=a=>{q.prepareStartTime=a[0],q.prepareEndTime=a[1],z.value=!1},ca=()=>{q.prepareStartTime="",q.prepareEndTime=""},ra=()=>{q.accountTypeId="",q.accountType=null,q.accountTypeName="",q.accountName="",q.account="",q.bank=""},sa=a=>{q.accountType=a.key,q.accountTypeName=a.name},ua=()=>{Z.value.push({prepareInfoId:"",prepareName:"",amount:"",description:""})},na=async()=>{var a,e,l;const t=(()=>{const{accountType:a,accountName:e,account:l,bank:t}=q;return a&&!e?"请输入账户名称":a&&!l?"请输入账号":"BANK_CARD"!=a||t?Z.value.some((a=>!a.prepareName))?"请选择整备项":Z.value.some((a=>!a.amount))?"请输入整备金额":"":"请输入开户行"})();if(t)return void(new d).showToast(t);(new d).showLoading("提交中");const o=(null==(l=null==(e=null==(a=X.value)?void 0:a.getFileFields())?void 0:e.all)?void 0:l.map((a=>a.attachmentId)))||[],c={...q,carProductId:L.value.carProductId,amount:aa.value.toFixed(2),attachments:o,prepareRelations:Z.value,id:L.value.id||void 0};await(L.value.id?M().put("/product/carProductPrepare",c):M().post("/product/carProductPrepare",c)),(new d).showToast("提交成功"),F()};return(a,e)=>{const l=N,t=f,o=_(h("up-icon"),y),c=R,r=j,s=x,u=_(h("u-calendar"),I),n=_(h("up-action-sheet"),k);return v(),i(t,{class:"page pend-page"},{default:m((()=>[T(t,{class:"content"},{default:m((()=>[T(B,{item:g(W).carProductBasic,isDetail:!0,isWorkOrder:!0},null,8,["item"]),T(t,{class:"form-box"},{default:m((()=>[T(t,{class:"form-item"},{default:m((()=>[T(t,null,{default:m((()=>[T(l,null,{default:m((()=>[P("*")])),_:1}),P("整备专员")])),_:1}),T(t,{class:"f-b-c",onClick:e[0]||(e[0]=e=>("toPage"in a?a.toPage:g(C))(`/pages/carManage/sellUserList?title=整备专员&id=${g(q).prepareUserId}`))},{default:m((()=>[T(l,{class:b({placeholder:!g(q).prepareUserName})},{default:m((()=>[P(A(g(q).prepareUserName||"请选择"),1)])),_:1},8,["class"]),T(o,{name:"arrow-right"})])),_:1})])),_:1}),T(t,{class:"form-item"},{default:m((()=>[T(t,null,{default:m((()=>[P("修理厂")])),_:1}),T(t,{class:"f-b-c",onClick:e[1]||(e[1]=e=>("toPage"in a?a.toPage:g(C))(`/pages/workOrder/repairFactory?id=${g(q).factoryInfoId}&pageKey=REPAIR_SHOP`))},{default:m((()=>[T(l,{class:b({placeholder:!g(q).factoryName})},{default:m((()=>[P(A(g(q).factoryName||"请选择"),1)])),_:1},8,["class"]),T(t,{class:"has-close"},{default:m((()=>[g(q).factoryName?(v(),i(l,{key:0,onClick:E(ta,["stop"])},{default:m((()=>[T(o,{name:"close-circle-fill",color:"#999"})])),_:1})):w("",!0),T(o,{name:"arrow-right"})])),_:1})])),_:1})])),_:1}),T(t,{class:"form-item"},{default:m((()=>[T(t,null,{default:m((()=>[T(l,null,{default:m((()=>[P("*")])),_:1}),P("付款方式")])),_:1}),T(t,{class:"tab-box"},{default:m((()=>[(v(!0),U(V,null,O(g(Q),((a,e)=>(v(),i(l,{key:e,class:b({active:g(q).paymentMethods==a.key}),onClick:e=>g(q).paymentMethods=a.key},{default:m((()=>[P(A(a.value),1)])),_:2},1032,["class","onClick"])))),128))])),_:1})])),_:1}),T(t,{class:"form-item account-item"},{default:m((()=>[T(t,null,{default:m((()=>[P("收款账户")])),_:1}),T(t,{class:"account-btn",onClick:e[2]||(e[2]=e=>("toPage"in a?a.toPage:g(C))("/pages/workOrder/accountList"))},{default:m((()=>[P("选择账户")])),_:1}),g(q).accountType?(v(),i(t,{key:0,class:"child-info"},{default:m((()=>[T(t,{class:"a-info-head"},{default:m((()=>[T(t,null,{default:m((()=>[P("已选账户")])),_:1}),T(t,{onClick:ra},{default:m((()=>[P("删除")])),_:1})])),_:1}),T(t,{class:"form-item"},{default:m((()=>[T(t,null,{default:m((()=>[T(l,null,{default:m((()=>[P("*")])),_:1}),P("账户类型")])),_:1}),T(t,{class:"f-b-c",onClick:e[3]||(e[3]=a=>G.value=!0)},{default:m((()=>[T(l,{class:b({placeholder:!g(q).accountType})},{default:m((()=>[P(A(g(q).accountTypeName||"请选择"),1)])),_:1},8,["class"]),T(o,{name:"arrow-right"})])),_:1})])),_:1}),T(t,{class:"form-item"},{default:m((()=>[T(t,null,{default:m((()=>[T(l,null,{default:m((()=>[P("*")])),_:1}),P("账户名称")])),_:1}),T(c,{modelValue:g(q).accountName,"onUpdate:modelValue":e[4]||(e[4]=a=>g(q).accountName=a),placeholder:"请输入"},null,8,["modelValue"])])),_:1}),T(t,{class:"form-item"},{default:m((()=>[T(t,null,{default:m((()=>[T(l,null,{default:m((()=>[P("*")])),_:1}),P("账号")])),_:1}),T(c,{modelValue:g(q).account,"onUpdate:modelValue":e[5]||(e[5]=a=>g(q).account=a),placeholder:"请输入"},null,8,["modelValue"])])),_:1}),"BANK_CARD"==g(q).accountType?(v(),i(t,{key:0,class:"form-item"},{default:m((()=>[T(t,null,{default:m((()=>[T(l,null,{default:m((()=>[P("*")])),_:1}),P("开户行")])),_:1}),T(c,{modelValue:g(q).bank,"onUpdate:modelValue":e[6]||(e[6]=a=>g(q).bank=a),placeholder:"请输入"},null,8,["modelValue"])])),_:1})):w("",!0)])),_:1})):w("",!0)])),_:1}),T(t,{class:"form-item",onClick:e[7]||(e[7]=a=>z.value=!0)},{default:m((()=>[T(t,null,{default:m((()=>[P("整备时间")])),_:1}),g(q).prepareStartTime?(v(),i(l,{key:0},{default:m((()=>[P(A(g(q).prepareStartTime.replace(/-/g,"/"))+"-"+A(g(q).prepareEndTime.replace(/-/g,"/")),1)])),_:1})):(v(),i(l,{key:1,class:"placeholder"},{default:m((()=>[P("请选择")])),_:1})),T(t,{class:"has-close"},{default:m((()=>[g(q).prepareStartTime?(v(),i(l,{key:0,onClick:E(ca,["stop"])},{default:m((()=>[T(o,{name:"close-circle-fill",color:"#999"})])),_:1})):w("",!0),T(o,{name:"arrow-right"})])),_:1})])),_:1}),T(t,{class:"form-item photo-item"},{default:m((()=>[T(t,null,{default:m((()=>[P("照片凭证")])),_:1}),T(K,{ref_key:"registerRef",ref:X,accept:"all","max-count":99,uploadList:g(q).attachments},null,8,["uploadList"])])),_:1}),T(t,{class:"form-textarea"},{default:m((()=>[T(t,{class:"area-title"},{default:m((()=>[P("补充说明")])),_:1}),T(r,{modelValue:g(q).description,"onUpdate:modelValue":e[8]||(e[8]=a=>g(q).description=a),placeholder:"请输入",maxlength:"200"},null,8,["modelValue"]),T(t,{class:"limit"},{default:m((()=>{var a;return[P(A((null==(a=g(q).description)?void 0:a.length)||0)+"/200",1)]})),_:1})])),_:1})])),_:1}),T(t,{class:"details form-box"},{default:m((()=>[T(t,{class:"details-title"},{default:m((()=>[P("整备明细")])),_:1}),(v(!0),U(V,null,O(g(Z),((e,s)=>(v(),i(t,{key:s,class:"details-content"},{default:m((()=>[T(t,{class:"head"},{default:m((()=>[T(t,null,{default:m((()=>[P("整备明细"+A(s+1),1)])),_:2},1024),g(Z).length>1?(v(),i(t,{key:0,onClick:a=>(a=>{Z.value.splice(a,1)})(s)},{default:m((()=>[P("删除")])),_:2},1032,["onClick"])):w("",!0)])),_:2},1024),T(t,{class:"child-info"},{default:m((()=>[T(t,{class:"form-item"},{default:m((()=>[T(t,null,{default:m((()=>[T(l,null,{default:m((()=>[P("*")])),_:1}),P("整备项")])),_:1}),T(t,{class:"f-b-c",onClick:l=>("toPage"in a?a.toPage:g(C))(`/pages/workOrder/repairFactory?id=${e.prepareInfoId}&pageKey=SERVICE_ITEM&index=${s}`)},{default:m((()=>[T(l,{class:b({placeholder:!e.prepareName})},{default:m((()=>[P(A(e.prepareName||"请选择"),1)])),_:2},1032,["class"]),T(o,{name:"arrow-right"})])),_:2},1032,["onClick"])])),_:2},1024),T(t,{class:"form-item"},{default:m((()=>[T(t,null,{default:m((()=>[T(l,null,{default:m((()=>[P("*")])),_:1}),P("金额")])),_:1}),T(c,{modelValue:e.amount,"onUpdate:modelValue":a=>e.amount=a,type:"number",placeholder:"请输入",maxlength:"7",onInput:a=>((a,e,l)=>{S((()=>{e.amount=H(a,l);const t=Z.value.reduce(((a,{amount:e})=>a+parseFloat(e||"0")),0);aa.value=t}))})(a.detail.value,e,"toFix")},null,8,["modelValue","onUpdate:modelValue","onInput"]),P(" 元 ")])),_:2},1024),T(t,{class:"form-item form-desc"},{default:m((()=>[T(t,null,{default:m((()=>[P("说明")])),_:1}),T(t,null,{default:m((()=>[T(r,{modelValue:e.description,"onUpdate:modelValue":a=>e.description=a,placeholder:"请输入",maxlength:"50"},null,8,["modelValue","onUpdate:modelValue"]),T(t,{class:"limit"},{default:m((()=>{var a;return[P(A((null==(a=e.description)?void 0:a.length)||0)+"/50",1)]})),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128)),T(t,{class:"add-details",onClick:ua},{default:m((()=>[T(o,{name:"plus-circle",color:"#de6728",class:"u-m-r-10"}),P("添加明细 ")])),_:1})])),_:1})])),_:1}),T(t,{class:"bottom-btn"},{default:m((()=>[T(t,null,{default:m((()=>[T(t,null,{default:m((()=>[P("整备总额")])),_:1}),T(t,null,{default:m((()=>[P("共"),T(l,{class:"price"},{default:m((()=>[P(A(g(Z).length),1)])),_:1}),P("笔"),T(t,{class:"price"},{default:m((()=>[P("￥"),T(l,null,{default:m((()=>[P(A(g(aa).toFixed(2)),1)])),_:1})])),_:1})])),_:1})])),_:1}),T(s,{class:"save-btn",onClick:na},{default:m((()=>[P("保存")])),_:1})])),_:1}),T(u,{show:g(z),mode:"range",color:"#ff5719",allowSameDay:!0,monthNum:"8",minDate:g(D)().subtract(2,"month"),onConfirm:oa,onClose:e[9]||(e[9]=a=>z.value=!1)},null,8,["show","minDate"]),T(n,{show:g(G),onClose:e[10]||(e[10]=a=>G.value=!1),actions:g(J),description:"账户类型",cancelText:"取消",onSelect:sa},null,8,["show","actions"])])),_:1})}}}),[["__scopeId","data-v-76cacda0"]]);export{Y as default};
