import{d as e,c as a,o as l,i as t,w as s,a as u,P as o,u as r,g as n,t as i,_ as c,r as d,x as v,a9 as p,I as m,aP as f,K as _,aQ as y,ac as h,b as g,e as I,F as b,a5 as j,ad as w,O as T,T as C,$ as k,Z as S,a2 as $,p as L,B,E as O,X as D,Y as M,D as x,a1 as N,s as A,ak as F,M as P,aq as z,y as R,n as U,Q as E,aU as q,a0 as J,c1 as K}from"./index-CK4DGatK.js";import{R as Q}from"./remarkPop.C_hUies3.js";import{L as Z}from"./ListLoadRefreshView.CnNC2lkG.js";import{z as G}from"./image.DobRSNlT.js";import{c as V}from"./crm.-ZWUD7KR.js";import{u as W}from"./useQuery.3dd8K18V.js";import{o as X}from"./omit.DzeQdT5l.js";import{N as Y,B as H,a as ee,b as ae}from"./NavBar.B8fX5M2s.js";import{u as le}from"./useSell.c71q6Fal.js";import{u as te}from"./useDict.DwAUsZFY.js";import"./close.Dhgi5Ijg.js";import"./_baseGet.CmhOSbYr.js";import"./_getTag.DG-N9UUn.js";import"./isObject.C8HfsiHw.js";import"./isSymbol.Bym6OQCA.js";import"./_Uint8Array.B4mhORiM.js";import"./_baseClone.Cc-Y92km.js";import"./callPhone.KEQUzljZ.js";import"./index.HDA2F_3Q.js";import"./carListItem.hYH6YShY.js";import"./time._VqwKl0d.js";import"./isNil.aV-w2MPu.js";import"./listItem.De6Dqo0z.js";import"./car_default.CyENNAub.js";import"./purchase.B8DNaFGL.js";import"./fixPrice.CFXyKkhm.js";import"./base.6l0JEBJr.js";import"./index.DEPEwlq9.js";const se=c(e({__name:"carDetailItem",props:{item:{type:Object,default:()=>{}}},setup:e=>(c,d)=>{const v=o,p=t;return l(),a(p,{class:"list-item"},{default:s((()=>[u(p,{class:"item-box"},{default:s((()=>[u(p,{class:"left"},{default:s((()=>[u(v,{src:("zipImg"in c?c.zipImg:r(G))(e.item.coverUrl,50),mode:"aspectFill"},null,8,["src"])])),_:1}),u(p,{class:"right"},{default:s((()=>[u(p,{class:"name"},{default:s((()=>[n(i(e.item.carBrandName)+" "+i(e.item.carSeriesName),1)])),_:1}),u(p,{class:"model-name"},{default:s((()=>[n(i(e.item.carModelName),1)])),_:1}),u(p,{class:"arguments"},{default:s((()=>[n(" 2023-05 | 2.36万公里 | 库龄11天 ")])),_:1}),u(p,{class:"price"},{default:s((()=>[n(" 未定价 ")])),_:1})])),_:1})])),_:1})])),_:1})}}),[["__scopeId","data-v-68b8bd3b"]]),ue=c(e({__name:"detailPop",props:{show:{type:Boolean},current:{default:"detail"},detail:{default:{}}},emits:["close"],setup(e,{emit:o}){const c=e,L=W(),B=o;d(["详情","匹配车辆"]);const O=["待联系","邀约","到店","成交"],D=["待联系","已战败"],M=["待联系","已无效"],x=v((()=>{var e,a;return 4===(null==(e=c.detail)?void 0:e.orderStatus)?D:5===(null==(a=c.detail)?void 0:a.orderStatus)?M:O})),N=v((()=>{var e,a,l;return null===(null==(e=c.detail)?void 0:e.orderStatus)?0:[4,5].includes(null==(a=c.detail)?void 0:a.orderStatus)?1:null==(l=c.detail)?void 0:l.orderStatus})),A=()=>{P.value="detail"===c.current?0:1,1===P.value?q():async function(){const e={clueId:L.value.clueId},a=await k().get(V.getClueBySell,{params:e});z.value=null==a?void 0:a.data}()},F=()=>{B("close")},P=d(0),z=d();const R=d([]),U=d(),E=p({current:1,size:10,total:0,orderStatus:"",orders:"createTimeDesc"});async function q(){var e;S({title:"加载中",mask:!0});try{const e={...X(E,"total")},a=await k().get("/product/purchaseOrder/pageList",{params:e});E.total=a.data.count;const l=a.data.results.map((e=>({...e,checked:!1})));R.value=1===E.current?l:[...R.value,...l]}finally{1==E.current&&U.value.initTop(),null==(e=U.value)||e.loadFinish(),$()}}const J=()=>{E.current=1,q()},K=()=>{E.current++,q()};return(e,o)=>{const d=m(_("up-steps-item"),f),v=m(_("up-steps"),y),p=t,k=j,S=m(_("u-popup"),h);return l(),a(S,{mode:"bottom",round:20,closeable:"",closeOnClickOverlay:!0,show:c.show,onOpen:A,onClose:F},{default:s((()=>[u(p,{class:"detail-pop"},{default:s((()=>[0===r(P)?(l(),a(p,{key:0,class:"pop-box"},{default:s((()=>[u(p,{class:"detail-item"},{default:s((()=>[u(v,{current:r(N),dot:"",activeColor:"#ff5719"},{default:s((()=>[(l(!0),g(b,null,I(r(x),(e=>(l(),a(d,{title:e,key:e},null,8,["title"])))),128))])),_:1},8,["current"])])),_:1}),u(k,{class:"scrolls","scroll-y":""},{default:s((()=>[u(p,{class:"info-item"},{default:s((()=>[u(p,{class:"label"},{default:s((()=>[n("意向程度:")])),_:1}),u(p,{class:"val"},{default:s((()=>{var e;return[n(i((null==(e=r(z))?void 0:e.intentionCode)||"--"),1)]})),_:1})])),_:1}),u(p,{class:"info-item"},{default:s((()=>[u(p,{class:"label"},{default:s((()=>[n("客户预算:")])),_:1}),u(p,{class:"val"},{default:s((()=>{var e;return[n(i((null==(e=r(z))?void 0:e.budgetary)||"--"),1)]})),_:1})])),_:1}),u(p,{class:"info-item"},{default:s((()=>[u(p,{class:"label"},{default:s((()=>[n("预计买车日期:")])),_:1}),u(p,{class:"val"},{default:s((()=>{var e;return[n(i((null==(e=r(z))?void 0:e.predictBuyCarTime)||"--"),1)]})),_:1})])),_:1}),u(p,{class:"info-item"},{default:s((()=>[u(p,{class:"label"},{default:s((()=>[n("意向车系:")])),_:1}),u(p,{class:"val"},{default:s((()=>{var e,a;return[n(i((null==(a=null==(e=r(z))?void 0:e.sellSeries)?void 0:a.join(","))||"--"),1)]})),_:1})])),_:1}),u(p,{class:"info-item"},{default:s((()=>[u(p,{class:"label"},{default:s((()=>[n("车体形式:")])),_:1}),u(p,{class:"val"},{default:s((()=>{var e,a;return[n(i((null==(a=null==(e=r(z))?void 0:e.carLayout)?void 0:a.join(","))||"--"),1)]})),_:1})])),_:1}),u(p,{class:"info-item"},{default:s((()=>[u(p,{class:"label"},{default:s((()=>[n("关注点:")])),_:1}),u(p,{class:"val"},{default:s((()=>{var e,a;return[n(i((null==(a=null==(e=r(z))?void 0:e.carFocus)?void 0:a.join(","))||"--"),1)]})),_:1})])),_:1}),u(p,{class:"info-item"},{default:s((()=>[u(p,{class:"label"},{default:s((()=>[n("购车方式:")])),_:1}),u(p,{class:"val"},{default:s((()=>{var e;return[n(i((null==(e=r(z))?void 0:e.paymentTypeStr)||"--"),1)]})),_:1})])),_:1}),u(p,{class:"info-item"},{default:s((()=>[u(p,{class:"label"},{default:s((()=>[n("描述:")])),_:1}),u(p,{class:"val"},{default:s((()=>{var e;return[n(i((null==(e=r(z))?void 0:e.description)||"--"),1)]})),_:1})])),_:1})])),_:1})])),_:1})):(l(),a(p,{key:1,class:"pop-box"},{default:s((()=>[u(Z,w({ref_key:"listLoadRef",ref:U,class:"scroll-view-box"},r(E),{istop:!1,onLoadMore:K,onLoadRefresh:J}),{default:s((()=>[T(u(p,{class:"list-box"},{default:s((()=>[(l(!0),g(b,null,I(r(R),((e,t)=>(l(),a(se,{key:t,item:e},null,8,["item"])))),128))])),_:1},512),[[C,r(R).length]])])),_:1},16)])),_:1}))])),_:1})])),_:1},8,["show"])}}}),[["__scopeId","data-v-6c4c4506"]]),oe=c(e({__name:"buyDetails",setup(e){const o=le(),r=W(),c=d(),v=d();K("crm-customerId",v);const p=["待联系","邀约","到店","成交"],f=d([]),y=d({arr:[],description:""}),h=d(0),j=d(),w=d(!0),T=d(),C=d([]),Z=d([]),G=d([]),X=d([]);function se(e){return null==e?void 0:e.map((e=>({key:e.value,value:e.label})))}const{customer_source:oe,vehicle_age_type:re,car_layout:ne,car_focus_type:ie}=te("customer_source","vehicle_age_type","car_layout","car_focus_type");L((()=>{oe.value&&(C.value=se(oe.value)),re.value&&(Z.value=se(re.value)),ne.value&&(G.value=se(ne.value)),ie.value&&(X.value=se(ie.value))})),B((()=>{je(),ce()})),O((async()=>{D("sellData"),M("sellData",(e=>{var a,l;const{id:t,queryData:s}=e,u=5==(null==(a=JSON.parse(s))?void 0:a.transfer)?"/crm/customer/transfer/approve":"/crm/customer/transfer";uni.$u.http.post(u,{type:c.value.clueType,clueIdList:[r.value.clueId],followUpId:t,transfer:5==(null==(l=JSON.parse(s))?void 0:l.transfer)}).then((()=>{(new x).showToast("提交成功"),setTimeout((()=>{N()}),1500)}))})),D("refreshDetail"),M("refreshDetail",(e=>{ce()}))}));const ce=()=>{S({title:"加载中",mask:!0});try{de(),ve()}finally{$()}};async function de(){var e,a;const l={clueId:r.value.clueId},t=await k().get(V.getUserByClueId,{params:l});c.value=null==t?void 0:t.data,v.value=null==(e=c.value)?void 0:e.userId;const{clueType:s,intentionCode:u,orderStatus:o}=t.data;f.value=[{clueType:s,intentionCode:u,orderStatus:o}],h.value+=1;const n=(null==(a=t.data)?void 0:a.allotAuth)?"":"分配";me.value=[{name:"编辑",value:"1"},{name:"出售",value:"2"},{name:"转评估",value:"3"},{name:"分配",value:"4"},{name:"移交",value:"5"},{name:"放弃",value:"6"}].filter((e=>e.name!=n)),A((()=>{var e;null==(e=j.value)||e.getElementTop()}))}const ve=()=>{uni.$u.http.get("/crm/customer/sell/clueId",{params:{customerId:r.value.id,clueId:r.value.clueId}}).then((e=>{y.value=e.data;const{vehicleAge:a,inventorySource:l,budgetMin:t,budgetMax:s,predictBuyCarTime:u,paymentType:o,carLayout:r,carFocus:n,description:i}=e.data,c=[];a&&c.push(`车龄 ${pe(Z.value,a)}`),(null==l?void 0:l.length)&&c.push(l.map((e=>e.carSeriesName)).join(",")),(t||s)&&c.push(`预算 ${t}-${s}万元`),u&&c.push(`预计 ${u}买车`),c.push((1==o?"全款":"分期")+"购车"),r&&c.push(pe(G.value,r.split(","))),n&&c.push(pe(G.value,n.split(","))),y.value={arr:c,description:i},Me(),A((()=>{var e;null==(e=j.value)||e.getElementTop()}))}))};function pe(e,a){if(e||(e=[]),Array.isArray(a)){const l=e.filter((e=>a.includes(e.key))).map((e=>e.value));return(null==l?void 0:l.length)?l.join(","):"请选择"}{const l=e.filter((e=>e.key==a));return(null==l?void 0:l.length)?l[0].value:"请选择"}}const me=d([]),fe=e=>{"放弃"===e.name?E(`/pagesB/crmManage/components/abandon?clueType=${c.value.clueType}&clueId=${r.value.clueId}`):"分配"===e.name||"移交"===e.name?E(`/pages/carManage/sellUserList?title=${e.name}&id=${c.value.userId}&sureBtn=1&queryData=${JSON.stringify({transfer:e.value})}`):"出售"===e.name?(o.sellParams={customerId:r.value.id,sellId:r.value.customerSellId},E("/pages/carManage/carList?type=ON_SALE&isOrder=0")):"转评估"===e.name?E(`/pagesB/crmManage/addCustom?${q({title:"新增评估机会",customerId:r.value.id,clueId:r.value.clueId,type:"purchaseAddDto",isChange:1})}`):"编辑"===e.name&&E(`/pagesB/crmManage/addCustom?${q({title:"编辑用户",customerId:r.value.id,clueId:r.value.clueId,type:"customerAddDto"})}`)},_e=()=>{E(`/pagesB/crmManage/components/buy/addFollow?clueId=${r.value.clueId}&clueType=${c.value.clueType}&customerId=${r.value.id}`)},ye=d(!1),he=d(!1),ge=d(),Ie=d([]),be=d(),je=()=>{uni.$u.http.get(V.intentionInfolist,{data:{current:1,size:-1,type:"1"}}).then((e=>{var a,l;Ie.value=null==(l=null==(a=e.data)?void 0:a.results)?void 0:l.map((e=>({name:e.code,value:e.code})))}))},we=()=>{ye.value=!0},Te=e=>{be.value=e,he.value=!0,"成交"===e.value?ge.value="成交时间":ge.value=`${e.name}原因`},Ce=()=>{he.value=!1},ke=e=>{const a={crmClueId:r.value.clueId,result:be.value.value,clueType:c.value.clueType,crmCustomerId:c.value.id};"成交"===be.value.value?a.dealTime=e:a.content=e,uni.$u.http.post(V.followLog,a).then((e=>{J({title:"操作成功",icon:"none"}),Ce(),de()}))},Se=d(!1),$e=d("detail"),Le=d(),Be=()=>{E(`/pagesB/crmManage/addCustom?${q({clueId:r.value.clueId,customerId:r.value.id,type:"sellAddDto",title:"编辑销售机会"})}`)},Oe=()=>{const e={clueType:c.value.clueType,crmCustomerId:c.value.id,attention:c.value.attention?0:1},a=c.value.attention?"取消重点客户成功":"标记重点客户成功";uni.$u.http.post(V.markImportant,e).then((()=>{J({title:a,icon:"none"}),de()}))},De=()=>{E(`/pagesB/crmManage/components/setTags?id=${r.value.id}&clueType=${r.value.clueType}`)},Me=()=>{setTimeout((()=>{F().in(this).select(".hide-desc").boundingClientRect((e=>{if(e){const a=Math.ceil(e.height/22);T.value=a>10}})).exec()}),30)},xe=()=>{var e;w.value=!w.value,null==(e=j.value)||e.getElementTop()};return(e,o)=>{const d=t,v=m(_("up-icon"),P),C=m(_("up-action-sheet"),z);return l(),a(d,{class:"buy-details"},{default:s((()=>{var e;return[u(Y,{data:c.value,onImport:Oe},null,8,["data"]),u(d,{class:"section"},{default:s((()=>[u(H,{ref_key:"baseInfoRef",ref:j,data:c.value,stepList1:p,chanceList:f.value,stepsKey:h.value,onAddTag:De},{detail:s((()=>[u(d,{class:"detail-list"},{default:s((()=>[(l(!0),g(b,null,I(y.value.arr,((e,t)=>(l(),a(d,{key:t},{default:s((()=>[n(i(e),1)])),_:2},1024)))),128))])),_:1}),u(d,{class:"des"},{default:s((()=>[u(d,null,{default:s((()=>[n("意向描述")])),_:1}),u(d,{class:U(["word-warp show-desc",{collapsed:!w.value}])},{default:s((()=>[n(i(y.value.description||"-"),1)])),_:1},8,["class"]),T.value?(l(),a(d,{key:0,class:"show-mores",onClick:xe},{default:s((()=>[n(i(w.value?"展开":"收起")+" ",1),u(v,{name:w.value?"arrow-down":"arrow-up",size:"14",color:"#0079fe"},null,8,["name"])])),_:1})):R("",!0),u(d,{class:"word-warp hide-desc"},{default:s((()=>[n(i(y.value.description||"-"),1)])),_:1})])),_:1})])),footer:s((()=>[u(d,{class:"action-btn",onClick:Be},{default:s((()=>[n("编辑机会")])),_:1}),u(d,{class:"action-btn",onClick:we},{default:s((()=>[n("结束机会")])),_:1}),u(d,{class:"action-btn",onClick:o[0]||(o[0]=e=>{return a="detail",$e.value=a,Le.value={...c.value,clueId:r.value.clueId},void(Se.value=!0);var a})},{default:s((()=>[n("详情")])),_:1})])),_:1},8,["data","chanceList","stepsKey"]),u(ee)])),_:1}),u(C,{title:"结束机会",class:"pop-action",onSelect:Te,onClose:o[1]||(o[1]=e=>ye.value=!1),actions:Ie.value,closeOnClickOverlay:!0,closeOnClickAction:!0,cancelText:"取消",show:ye.value},null,8,["actions","show"]),u(ae,{options:me.value,phone:null==(e=c.value)?void 0:e.phone,onSheet:fe,onFollow:_e},null,8,["options","phone"]),u(Q,{show:he.value,title:ge.value,onClose:Ce,onSubmit:ke},null,8,["show","title"]),u(ue,{show:Se.value,current:$e.value,onClose:o[2]||(o[2]=e=>Se.value=!1),detail:Le.value},null,8,["show","current","detail"])]})),_:1})}}}),[["__scopeId","data-v-5ddedbe6"]]);export{oe as default};
