import{d as e,G as l,r as a,E as t,X as u,Y as s,Z as r,a2 as n,$ as o,b as i,a as d,w as c,u as m,F as v,i as f,I as p,M as _,K as y,ah as g,o as b,c as h,y as k,k as C,g as N,h as j,R as w,Q as I,e as L,n as P,t as D,P as M,W as T,a0 as x,a1 as F,ai as U,D as V,_ as R}from"./index-CK4DGatK.js";import{p as $}from"./image.DobRSNlT.js";import{L as E}from"./testDriveDetailItem.DjqyF4_P.js";import{d as A,g as B}from"./customer.BR_0pqR6.js";import{U as O}from"./UploadFile.BBuXxkzB.js";import{c as q}from"./validator.D4swjSxv.js";import{u as S}from"./useQuery.3dd8K18V.js";import{d as G}from"./debounce.BkVTat1y.js";import"./time._VqwKl0d.js";import"./car_default.CyENNAub.js";import"./dev.3CSglq9A.js";import"./index.BP9c-u7r.js";import"./play.dJbs8fP_.js";import"./vuedraggable.umd.DwpyKIuh.js";import"./isObject.C8HfsiHw.js";import"./isSymbol.Bym6OQCA.js";const K=R(e({__name:"testDriveDetail",setup(e){const R=S(),K=JSON.parse(l("userBtnPermission"))||[],Q=a(),Z=a(),J=a(!1),W=a(!1),X=a(!1),Y=a({}),z=a([]),H=a([{key:"1",value:"试驾"},{key:"2",value:"试乘"},{key:"3",value:"试驾/试乘"}]),ee=e=>{switch(e){case"CREATE_CONTRACT":return"未签署";case"CONTRACT_SIGNED":return"已签署";case"CANCEL":return"已取消";default:return"-"}},le=a({customerMobile:"",customerName:"",idNumber:"",drivingLicense:[],type:""});t((async()=>{u("customerData"),s("customerData",(e=>{const{name:l,realPhone:a,id:t,idNumber:u}=e;le.value.customerMobile=a,le.value.idNumber=u,le.value.customerName=l,W.value=!1,z.value=[]})),r({title:"加载中",mask:!0});try{!async function(){var e;if(!R.value.id)return;const l=await o().get(`/product/carTestDrive/${"4"==R.value.type?"detailByCarProductId":"detail"}/${R.value.id}`);J.value="4"==(null==(e=R.value)?void 0:e.type),Y.value=null==l?void 0:l.data}()}finally{n()}}));const ae=G((()=>A({value:le.value.customerMobile,elRef:Q,visible:W,list:z,subKey:"phone",length:11,requestFn:B})),300),te=()=>{var e,l,a;if(!le.value.customerMobile)return x({title:"请输入手机号",icon:"none"});if(!le.value.customerMobile)return x({title:"请输入姓名",icon:"none"});if(!le.value.idNumber)return x({title:"请输入身份证号",icon:"none"});if(!le.value.type)return x({title:"请选择类型",icon:"none"});if(le.value.drivingLicense.length>0)return x({title:"请上传驾驶证",icon:"none"});const t=null==(a=null==(l=null==(e=Z.value)?void 0:e.getFileFields())?void 0:l.all)?void 0:a.map((e=>e.attachmentId));r({title:"提交中",mask:!0}),uni.$u.http.post("/product/carTestDrive/add",{...le.value,carProductId:Y.value.carProductId,drivingLicense:t}).then((e=>{x({title:"操作成功",icon:"none"}),F(),n()}))},ue=()=>{r({title:"取消中",mask:!0}),uni.$u.http.post(`/product/carTestDrive/cancel/${Y.value.id}`).then((()=>{x({title:"取消成功",icon:"none"}),F(),n()}))},se=()=>{F()},re=e=>{const l=e.detail.value;l&&!q(l)&&(new V).showToast("身份证号格式不正确")};return(e,l)=>{const a=f,t=j,u=w,s=p(y("up-icon"),_),r=M,n=T,o=p(y("up-modal"),g);return b(),i(v,null,[d(a,{class:"page f-c-s"},{default:c((()=>{var o;return[d(a,{class:"header"},{default:c((()=>[d(E,{item:m(Y),page:"detail",query:m(R)},null,8,["item","query"])])),_:1}),m(J)?(b(),h(a,{key:0,class:"bgFff"},{default:c((()=>[C("div",{class:"form-item input-complete",ref_key:"customerPhoneFormItemRef",ref:Q},[d(a,null,{default:c((()=>[d(t,null,{default:c((()=>[N("*")])),_:1}),N("驾驶人手机号")])),_:1}),d(u,{onInput:m(ae),modelValue:m(le).customerMobile,"onUpdate:modelValue":l[0]||(l[0]=e=>m(le).customerMobile=e),placeholder:"请输入",type:"number",maxlength:"11"},null,8,["onInput","modelValue"]),d(s,{onClick:l[1]||(l[1]=l=>("toPage"in e?e.toPage:m(I))(`/pages/carManage/customerList?keyword=${m(le).customerMobile}`)),name:"arrow-right"})],512),d(a,{class:"form-item"},{default:c((()=>[d(a,null,{default:c((()=>[d(t,null,{default:c((()=>[N("*")])),_:1}),N("驾驶人姓名")])),_:1}),d(u,{modelValue:m(le).customerName,"onUpdate:modelValue":l[2]||(l[2]=e=>m(le).customerName=e),type:"text",placeholder:"请输入姓名"},null,8,["modelValue"])])),_:1}),d(a,{class:"form-item"},{default:c((()=>[d(a,null,{default:c((()=>[d(t,null,{default:c((()=>[N("*")])),_:1}),N("身份证号")])),_:1}),d(u,{modelValue:m(le).idNumber,"onUpdate:modelValue":l[3]||(l[3]=e=>m(le).idNumber=e),type:"text",maxlength:"18",placeholder:"请输入身份证号",onBlur:re},null,8,["modelValue"])])),_:1}),d(a,{class:"form-item photo-item"},{default:c((()=>[d(a,null,{default:c((()=>[d(t,null,{default:c((()=>[N("*")])),_:1}),N("驾驶证")])),_:1}),d(O,{ref_key:"contractUploadRef",ref:Z,accept:"all","max-count":1,uploadList:m(le).drivingLicense},null,8,["uploadList"])])),_:1}),d(a,{class:"form-item"},{default:c((()=>[d(a,null,{default:c((()=>[d(t,null,{default:c((()=>[N("*")])),_:1}),N("类型")])),_:1}),d(a,{class:"tab-box"},{default:c((()=>[(b(!0),i(v,null,L(m(H),((e,l)=>(b(),h(t,{key:l,class:P({active:m(le).type==e.key}),onClick:l=>m(le).type=e.key},{default:c((()=>[N(D(e.value),1)])),_:2},1032,["class","onClick"])))),128))])),_:1})])),_:1})])),_:1})):(b(),h(a,{key:1,class:"bgFff"},{default:c((()=>[C("div",{class:"form-item input-complete",ref_key:"customerPhoneFormItemRef",ref:Q},[d(a,null,{default:c((()=>[N("驾驶人手机号")])),_:1}),d(a,null,{default:c((()=>{var e;return[N(D(null==(e=m(Y))?void 0:e.customerPhone),1)]})),_:1})],512),d(a,{class:"form-item"},{default:c((()=>[d(a,null,{default:c((()=>[N("驾驶人姓名")])),_:1}),d(a,null,{default:c((()=>{var e;return[N(D((null==(e=m(Y))?void 0:e.customerName)??"--"),1)]})),_:1})])),_:1}),d(a,{class:"form-item"},{default:c((()=>[d(a,null,{default:c((()=>[N("身份证号")])),_:1}),d(a,null,{default:c((()=>{var e;return[N(D((null==(e=m(Y))?void 0:e.idNumber)??"--"),1)]})),_:1})])),_:1}),d(a,{class:"form-item photo-item"},{default:c((()=>{var t,u;return[d(a,null,{default:c((()=>[N("驾驶证")])),_:1}),(null==(t=m(Y))?void 0:t.drivingLicense)&&(null==(u=m(Y))?void 0:u.drivingLicense.length)>0?(b(),h(a,{key:0,class:"val attachment"},{default:c((()=>{var a;return[d(r,{src:null==(a=m(Y))?void 0:a.drivingLicense[0],mode:"aspectFill",class:"drivingLicenseImg",onClick:l[4]||(l[4]=l=>{var a;return("previewImage"in e?e.previewImage:m($))(null==(a=m(Y))?void 0:a.drivingLicense)})},null,8,["src"])]})),_:1})):(b(),h(a,{key:1,class:"val"},{default:c((()=>[N("-")])),_:1}))]})),_:1}),d(a,{class:"form-item"},{default:c((()=>[d(a,null,{default:c((()=>[N("类型")])),_:1}),d(a,null,{default:c((()=>{var e;return[N(D((null==(e=m(Y))?void 0:e.typeName)??"--"),1)]})),_:1})])),_:1}),d(a,{class:"form-item"},{default:c((()=>{var u,s;return[d(a,null,{default:c((()=>[N("承诺书")])),_:1}),(null==(u=m(Y))?void 0:u.previewUrl)&&3!=(null==(s=m(Y))?void 0:s.status)?(b(),h(t,{key:0},{default:c((()=>{var a,u,s;return[N(D(null==(a=m(Y))?void 0:a.contractName),1),d(t,{class:"red"},{default:c((()=>{var e;return[N("("+D(ee(null==(e=m(Y))?void 0:e.signType))+")",1)]})),_:1}),d(t,{class:"red preview",onClick:l[5]||(l[5]=l=>{var a;return("toPage"in e?e.toPage:m(I))(`/pages/carManage/pdf?url=${null==(a=m(Y))?void 0:a.previewUrl}`)})},{default:c((()=>[N("预览>")])),_:1}),(null==(u=m(Y))?void 0:u.shortUrl)&&1==(null==(s=m(Y))?void 0:s.status)?(b(),h(t,{key:0,onClick:l[6]||(l[6]=e=>{var l,a;return a=null==(l=m(Y))?void 0:l.shortUrl,void U({data:a,success:function(){x({title:"复制成功",icon:"success"})}})}),class:"preview two"},{default:c((()=>[N(" 复制 ")])),_:1})):k("",!0)]})),_:1})):(b(),h(t,{key:1},{default:c((()=>[N("--")])),_:1}))]})),_:1})])),_:1})),"1"==(null==(o=m(Y))?void 0:o.status)&&m(K).includes("carTestDrive::edit")?(b(),h(a,{key:2,class:"bottom-btn"},{default:c((()=>[d(n,{class:"of-btn",onClick:l[7]||(l[7]=()=>X.value=!0)},{default:c((()=>[N("取消试驾")])),_:1})])),_:1})):k("",!0),"4"==m(R).type?(b(),h(a,{key:3,class:"bottom-btn"},{default:c((()=>[d(n,{onClick:se},{default:c((()=>[N("取消")])),_:1}),d(n,{class:"save-btn",onClick:te},{default:c((()=>[N("提交")])),_:1})])),_:1})):k("",!0)]})),_:1}),d(o,{width:"500rpx",showCancelButton:!0,show:m(X),content:"确定取消试驾吗？",onCancel:l[8]||(l[8]=e=>X.value=!1),onConfirm:ue},null,8,["show"])],64)}}}),[["__scopeId","data-v-d2122f28"]]);export{K as default};
